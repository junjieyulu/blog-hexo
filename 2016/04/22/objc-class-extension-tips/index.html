<!DOCTYPE html><html lang="zh-cn"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> 巧用 Class Extension 分离接口依赖 · sunnyxx的技术博客</title><meta name="description" content="巧用 Class Extension 分离接口依赖 - sunnyxx"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="short icon" href="/favicon.ico"><link rel="stylesheet" href="/css/apollo.css"></head><body><header><a href="/" class="logo-link"><img src="/doge-logo.png"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">BLOG</a></li><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">ARCHIVE</a></li><li class="nav-list-item"><a href="http://weibo.com/1364395395/" target="_blank" class="nav-list-link">WEIBO</a></li><li class="nav-list-item"><a href="https://github.com/forkingdog" target="_blank" class="nav-list-link">GITHUB</a></li><li class="nav-list-item"><a href="/atom.xml" target="_self" class="nav-list-link">RSS</a></li></ul></header><section class="container"><div class="post"><article class="post-block"><h1 class="post-title">巧用 Class Extension 分离接口依赖</h1><div class="post-time">2016年4月22日</div><div class="post-content"><p><code>Class Extension</code> 和 <code>Category</code> 是我们经常使用的 Objective-C 语法：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Class Extension</span></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">Sark</span> ()</span></span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Category</span></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">Sark</span> (<span class="title">Gay</span>)</span></span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>
<p>还记得最开始学习 Objective-C 时，并没有支持 Class Extension，当时只能凑活的用个 Private 的 Category 充当，需要添加私有成员变量时那叫个痛苦，直到大概四年前的 WWDC 终于宣布添加上了 Class Extension 的语法，当时底下的开发者们含泪报以了热烈掌声，它让类的封装变的更加得心用手。</p>
<p>在类组织结构上，Category 可以用来帮助拆分功能，让一个大型的类分治管理：（类似 <code>NSString.h</code> ）</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Sark.h</span></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">Sark</span> : <span class="title">NSObject</span></span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">copy</span>) <span class="built_in">NSSting</span> *name;</span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">Sark</span> (<span class="title">Gay</span>)</span></span><br><span class="line">- (<span class="keyword">void</span>)behaviorLikeGay;</span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Sark+Work.h &lt;----- 也可拆分成多个文件</span></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">Sark</span> (<span class="title">Work</span>)</span></span><br><span class="line">- (<span class="keyword">void</span>)writeObjectiveC;</span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>
<p>不过有两个设计原则必须要遵守：</p>
<ol>
<li>Category 的实现可以依赖主类，但主类一定不依赖 Category，也就是说移除任何一个 Category 的代码不会对主类产生任何影响。</li>
<li>Category 可以直接使用主类已有的私有成员变量，但不应该为实现 Category 而往主类中添加成员变量，考虑在 Category 的实现中使用 <code>objc association</code> 来达到相同效果。</li>
</ol>
<blockquote>
<p>所以 Category 一定是简单插拔的，就像买个外接键盘来扩展在 MacBook 上的写码能力，但当拔了键盘，MacBook 的运行不会受到任何影响。</p>
</blockquote>
<p>而 Class Extension 和 Category 在语言机制上有着很大差别：Class Extension 在编译期就会将定义的 Ivar、属性、方法等直接合入主类，而 Category 在程序启动 Runtime Loading 时才会将属性（没 Ivar）和方法合入主类。但有意思的是，两者在在语法解析层面却只有细微的差别，可以尝试用 <code>clang</code> 命令查看一个文件的 <code>AST</code>（抽象语法树）</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ clang -Xclang -ast-dump -fsyntax-only main.m</span><br></pre></td></tr></table></figure>
<blockquote>
<p>生成 AST 是 Clang 其中一个比较重要的职责，像 Xcode 的代码补全、语法检查、代码风格规范都是在这一层做的；如果像我一样无聊，也可以玩玩 <a href="http://clang.llvm.org/doxygen/group__CINDEX.html" target="_blank" rel="external">libclang</a>，一个 C 语言 Clang API，输入代码，就能将其解析成语法树，通过遍历 AST，可以取得每个 Decl 和 Token 的信息和所处的源码行数和位置，大到类定义，小到一个逗号一个分号都能完全掌控，非常有助于理解编译器如何处理源码；有了 libclang，定义些规则就能实现个简单的 Linter 啦。</p>
</blockquote>
<p>上面的命令会在控制台中打印出一堆花花绿绿的语法树结构，挑出我们关注的信息：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">// ...</span><br><span class="line">|-ObjCCategoryDecl &lt;line:7:1, line:9:2&gt; line:7:12</span><br><span class="line">| |-ObjCInterface &apos;Sark&apos;</span><br><span class="line">|-ObjCCategoryDecl &lt;line:15:1, line:17:2&gt; line:15:12 Gay</span><br><span class="line">| |-ObjCInterface &apos;Sark&apos;</span><br><span class="line">// ...</span><br></pre></td></tr></table></figure>
<p>可以看出，Class Extension 和 Category 在 AST 中的表示都是 <code>ObjCCategoryDecl</code>，只是有无名字的区别，也可以说 <strong>Class Extension 是匿名的 Category</strong>。</p>
<p>既然 Category 可以有 N 个，Class Extension 也可以有，且它不限于写在 <code>.m</code> 中，只要在 <code>@implementation</code> 前定义就可以，我们可以利用这个性质，将 Header 中的声明按功能归类：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Sark.h</span></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">Sark</span> : <span class="title">NSObject</span></span></span><br><span class="line"><span class="comment">// 这里定义了很多基本属性和方法</span></span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">Sark</span> () // <span class="title">Gay</span></span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">copy</span>) <span class="built_in">NSString</span> *gayFriend; <span class="comment">// 属性 √</span></span><br><span class="line">- (<span class="keyword">void</span>)behaviorLikeGay;</span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">Sark</span> () // <span class="title">Work</span></span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">copy</span>) <span class="built_in">NSString</span> *company; <span class="comment">// 属性 √</span></span><br><span class="line">- (<span class="keyword">void</span>)writeObjectiveC;</span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>
<p>与 Category 不同，Class Extension 的分组形式并没有破坏 “一个主类” 的 <del>基本外交原则</del> 基本结构，还可以把属性（ Ivar ）也放心丢进来。</p>
<p>— 正题分割线 —</p>
<p>除此之外，Class Extension 还能巧妙的解决一个接口暴露问题，若有下面的声明：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Sark.framework/Sark.h</span></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">Sark</span> : <span class="title">NSObject</span></span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">copy</span>) <span class="built_in">NSString</span> *name;</span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">copy</span>) <span class="built_in">NSString</span> *creditCardPassword; <span class="comment">// secret!</span></span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Sark.framework/PrivateSarkWife.h</span></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">PrivateSarkWife</span> : <span class="title">NSObject</span></span></span><br><span class="line">- (<span class="keyword">void</span>)robAllMoneyFromCreditCardOfSark:(Sark *)sark; <span class="comment">// needs password!</span></span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>
<p>假设 <code>Sark.h</code> 是 <code>Sark.framework</code> 唯一暴露的 Header，而 framework 中的一个私有类需要获取这个公共类的某个属性（或方法）该怎么办？上面的 <code>creditCardPassword</code> 属性需要一个对外不可见而对内可见的地方声明，这时候可以利用 Class Extension：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Sark.h</span></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">Sark</span> : <span class="title">NSObject</span></span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">copy</span>) <span class="built_in">NSString</span> *name;</span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Sark+Internal.h &lt;--- new</span></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">Sark</span> ()</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">copy</span>) <span class="built_in">NSString</span> *creditCardPassword;</span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Sark.m</span></span><br><span class="line"><span class="meta">#import <span class="meta-string">"Sark.h"</span></span></span><br><span class="line"><span class="meta">#import <span class="meta-string">"Sark+Internal.h"</span> // <span class="meta-string">&lt;--- new</span></span></span><br></pre></td></tr></table></figure>
<p><strong>将对公业务和对私业务用 Class Extension 的形式拆到两个 Header 中</strong>，这样私有类对私有属性的依赖就被成功隔离开了：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// PrivateSarkWife.m</span></span><br><span class="line"><span class="meta">#import <span class="string">"PrivateSarkWife.h"</span></span></span><br><span class="line"><span class="meta">#import <span class="string">"Sark+Internal.h"</span> <span class="comment">// &lt;--- 私有依赖</span></span></span><br><span class="line"></span><br><span class="line">@implementation PrivateSarkWife</span><br><span class="line">- (<span class="keyword">void</span>)robAllMoneyFromCreditCardOfSark:(Sark *)sark &#123;</span><br><span class="line">    NSString *password = sark.creditCardPassword; <span class="comment">// oh yeah!</span></span><br><span class="line">&#125;</span><br><span class="line">@end</span><br></pre></td></tr></table></figure>
<p>Done.</p>
</div></article></div></section><footer><div class="paginator"><a href="/2015/12/19/self-manager-pattern-in-ios/" class="next">下一篇</a></div><div data-thread-key="2016/04/22/objc-class-extension-tips/" data-title="巧用 Class Extension 分离接口依赖" data-url="http://blog.sunnyxx.com/2016/04/22/objc-class-extension-tips/" data-author-key="1" class="ds-thread"></div><script>var duoshuoQuery = {short_name:"sunnyxx"};
(function() {
    var ds = document.createElement('script');
    ds.type = 'text/javascript';ds.async = true;
    ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
    ds.charset = 'UTF-8';
    (document.getElementsByTagName('head')[0] 
     || document.getElementsByTagName('body')[0]).appendChild(ds);
})();

</script><div class="copyright"><p>原创文章，版权声明：署名-非商业性使用-相同方式共享 2.5 </p><p>对博主感兴趣？微信订阅号中关注 sunnyxx 或关注微博<a href="http://weibo.com/1364395395/">@我就叫Sunny怎么了</a></p><p>© 2015 - 2016  <a href="http://blog.sunnyxx.com">sunnyxx</a> | Powered by Hexo</p></div></footer></body></html>