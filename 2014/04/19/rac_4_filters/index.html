<!DOCTYPE html><html lang="zh-cn"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> Reactive Cocoa Tutorial [4] = 只取所需的Filters · sunnyxx的技术博客</title><meta name="description" content="Reactive Cocoa Tutorial [4] = 只取所需的Filters - sunnyxx"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="short icon" href="/favicon.ico"><link rel="stylesheet" href="/css/apollo.css"></head><body><header><a href="/" class="logo-link"><img src="/doge-logo.png"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">BLOG</a></li><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">ARCHIVE</a></li><li class="nav-list-item"><a href="http://weibo.com/1364395395/" target="_blank" class="nav-list-link">WEIBO</a></li><li class="nav-list-item"><a href="https://github.com/forkingdog" target="_blank" class="nav-list-link">GITHUB</a></li><li class="nav-list-item"><a href="/atom.xml" target="_self" class="nav-list-link">RSS</a></li></ul></header><section class="container"><div class="post"><article class="post-block"><h1 class="post-title">Reactive Cocoa Tutorial [4] = 只取所需的Filters</h1><div class="post-time">2014年4月19日</div><div class="post-content"><h1 id="我是前言"><a href="#我是前言" class="headerlink" title="我是前言"></a>我是前言</h1><p>这是<a href="http://blog.sunnyxx.com/tags/Reactive%20Cocoa%20Tutorial/">Reactive Cocoa Tutorial系列</a>其中的一篇，<a href="http://blog.sunnyxx.com/2014/03/06/rac_3_racsignal/">上一篇</a>简单介绍了RAC中最重要的<code>RACSignal</code>，下面几篇文章将主要从它的<code>Operations</code>下手，这也是工程中使用RAC的重点。从简到难，本篇文章先介绍RAC消息流的<code>过滤器-Filters</code>类别的相关方法。</p>
<hr>
<p>#RAC中的Filters</p>
<h2 id="画个范围"><a href="#画个范围" class="headerlink" title="画个范围"></a>画个范围</h2><p>一个Signal源可以产生一系列next值，但并非所有值都是需要的，具体的Subscriber可以选择在原有Signal上套用Filter操作来过滤掉不需要的值。<br>我的定义：RAC中如果一个<code>Operation</code>将处理后的值集合是处理前值集合的<code>子集</code>，我们就可以把它归为<code>Filter</code>类型。  </p>
<p>当然通过之前介绍的基础操作完全可以自己拼出个想要的filter来，RAC为了方便使用已经实现了几个常用的filter，经过总结，这些filter大概可以分成两类：<code>next值过滤类型</code>和<code>起止点过滤类型</code></p>
<h2 id="值过滤类型Filters"><a href="#值过滤类型Filters" class="headerlink" title="值过滤类型Filters"></a>值过滤类型Filters</h2><h3 id="filter-BOOL-id-value"><a href="#filter-BOOL-id-value" class="headerlink" title="filter: (BOOL (^)(id value))"></a>filter: (BOOL (^)(id value))</h3><p>RAC中的filter同名方法<code>- filter:(BOOL (^)(id value))</code>，简单明了，将一个value用block做test，返回YES的才会通过，它的内部实现使用了<code>- flattenMap:</code>，将原来的<code>Signal</code>经过过滤转化成只返回过滤值的<code>Signal</code>，用法也不难理解：    </p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[[<span class="keyword">self</span>.inputTextField.rac_textSignal filter:^<span class="built_in">BOOL</span>(<span class="built_in">NSString</span> *value) &#123;</span><br><span class="line">    <span class="keyword">return</span> [value hasPrefix:<span class="string">@"sunny"</span>];</span><br><span class="line">&#125;] subscribeNext:^(<span class="built_in">NSString</span> *value) &#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"This value has prefix `sunny` : %@"</span>, value);</span><br><span class="line">&#125;];</span><br></pre></td></tr></table></figure>
<p>此外，还有几个这个方法的衍生方法：   </p>
<h3 id="ignore-id"><a href="#ignore-id" class="headerlink" title="- ignore: (id)"></a>- ignore: (id)</h3><p>忽略给定的值，注意，这里忽略的既可以是地址相同的对象，也可以是<code>- isEqual:</code>结果相同的值，也就是说自己写的Model对象可以通过重写<code>- isEqual:</code>方法来使<code>- ignore:</code>生效。常用的值的判断没有问题，如下：      </p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[[<span class="keyword">self</span>.inputTextField.rac_textSignal ignore:<span class="string">@"sunny"</span>] subscribeNext:^(<span class="built_in">NSString</span> *value) &#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"`sunny` could never appear : %@"</span>, value);</span><br><span class="line">&#125;];</span><br></pre></td></tr></table></figure>
<h3 id="ignoreValues"><a href="#ignoreValues" class="headerlink" title="- ignoreValues"></a>- ignoreValues</h3><p>这个比较极端，忽略所有值，只关心Signal结束，也就是只取<code>Comletion</code>和<code>Error</code>两个消息，中间所有值都丢弃。<br>注意，这个操作应该出现在Signal有终止条件的的情况下，如<code>rac_textSignal</code>这样除<code>dealloc</code>外没有终止条件的Signal上就不太可能用到。   </p>
<h3 id="distinctUntilChanged"><a href="#distinctUntilChanged" class="headerlink" title="- distinctUntilChanged"></a>- distinctUntilChanged</h3><p>也是一个<strong>相当常用</strong>的Filter（但它不是- filter:的衍生方法），它将这一次的值与上一次做比较，当相同时（也包括<code>- isEqual:</code>）被忽略掉。<br>比如UI上一个Label绑定了一个值，根据值更新显示的内容:</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">RAC(<span class="keyword">self</span>.label, text) = [RACObserve(<span class="keyword">self</span>.user, username) distinctUntilChanged];</span><br><span class="line"><span class="keyword">self</span>.user.username = <span class="string">@"sunnyxx"</span>; <span class="comment">// 1st</span></span><br><span class="line"><span class="keyword">self</span>.user.username = <span class="string">@"sunnyxx"</span>; <span class="comment">// 2nd</span></span><br><span class="line"><span class="keyword">self</span>.user.username = <span class="string">@"sunnyxx"</span>; <span class="comment">// 3rd</span></span><br></pre></td></tr></table></figure>
<p>如果不增加<code>distinctUntilChanged</code>的话对于连续的相同的输入值就会有不必要的处理，这个栗子只是简单的UI刷新，但遇到如写数据库，发网络请求的情况时，代价就不能购忽略了。  </p>
<p>所以，对于相同值可以忽略的情况，果断加上它吧。   </p>
<h2 id="起止点过滤类型"><a href="#起止点过滤类型" class="headerlink" title="起止点过滤类型"></a>起止点过滤类型</h2><p>除了被动的当next值来的时候做判断，也可以主动的提前选择开始和结束条件，分为两种类型：<br><code>take型（取）</code>和<code>skip型(跳)</code></p>
<h3 id="take-NSUInteger"><a href="#take-NSUInteger" class="headerlink" title="- take: (NSUInteger)"></a>- take: (NSUInteger)</h3><p>从开始一共取N次的next值，不包括<code>Competion</code>和<code>Error</code>，如：   </p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[[[RACSignal createSignal:^RACDisposable *(<span class="keyword">id</span>&lt;RACSubscriber&gt; subscriber) &#123;</span><br><span class="line">    [subscriber sendNext:<span class="string">@"1"</span>];</span><br><span class="line">    [subscriber sendNext:<span class="string">@"2"</span>];</span><br><span class="line">    [subscriber sendNext:<span class="string">@"3"</span>];</span><br><span class="line">    [subscriber sendCompleted];</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nil</span>;</span><br><span class="line">&#125;] take:<span class="number">2</span>] subscribeNext:^(<span class="keyword">id</span> x) &#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"only 1 and 2 will be print: %@"</span>, x);</span><br><span class="line">&#125;];</span><br></pre></td></tr></table></figure>
<h3 id="takeLast-NSUInteger"><a href="#takeLast-NSUInteger" class="headerlink" title="- takeLast: (NSUInteger)"></a>- takeLast: (NSUInteger)</h3><p>取最后N次的next值，注意，由于一开始不能知道这个Signal将有多少个next值，所以RAC实现它的方法是将所有next值都存起来，然后<strong>原Signal完成时</strong>再将后N个<strong>依次</strong>发送给接收者，但Error发生时依然是立刻发送的。</p>
<p>###- takeUntil:(RACSignal *)<br>当给定的signal完成前一直取值。最简单的栗子就是<code>UITextField</code>的<code>rac_textSignal</code>的实现（删减版本）:</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">- (RACSignal *)rac_textSignal &#123;</span><br><span class="line">	@weakify(<span class="keyword">self</span>);</span><br><span class="line">	<span class="keyword">return</span> [[[[[RACSignal</span><br><span class="line">		concat:[<span class="keyword">self</span> rac_signalForControlEvents:<span class="built_in">UIControlEventEditingChanged</span>]]</span><br><span class="line">		map:^(<span class="built_in">UITextField</span> *x) &#123;</span><br><span class="line">			<span class="keyword">return</span> x.text;</span><br><span class="line">		&#125;]</span><br><span class="line">		takeUntil:<span class="keyword">self</span>.rac_willDeallocSignal] <span class="comment">// bingo!</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>也就是这个Signal一直到textField执行<code>dealloc</code>时才停止</p>
<h3 id="takeUntilBlock-BOOL-id-x"><a href="#takeUntilBlock-BOOL-id-x" class="headerlink" title="- takeUntilBlock:(BOOL (^)(id x))"></a>- takeUntilBlock:(BOOL (^)(id x))</h3><p>对于每个next值，运行block，当block返回YES时停止取值，如：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[[<span class="keyword">self</span>.inputTextField.rac_textSignal takeUntilBlock:^<span class="built_in">BOOL</span>(<span class="built_in">NSString</span> *value) &#123;</span><br><span class="line">    <span class="keyword">return</span> [value isEqualToString:<span class="string">@"stop"</span>];</span><br><span class="line">&#125;] subscribeNext:^(<span class="built_in">NSString</span> *value) &#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"current value is not `stop`: %@"</span>, value);</span><br><span class="line">&#125;];</span><br></pre></td></tr></table></figure>
<h3 id="takeWhileBlock-BOOL-id-x"><a href="#takeWhileBlock-BOOL-id-x" class="headerlink" title="- takeWhileBlock:(BOOL (^)(id x))"></a>- takeWhileBlock:(BOOL (^)(id x))</h3><p>上面的反向逻辑，对于每个next值，block返回    YES时才取值</p>
<h3 id="skip-NSUInteger"><a href="#skip-NSUInteger" class="headerlink" title="- skip:(NSUInteger)"></a>- skip:(NSUInteger)</h3><p>从开始跳过N次的next值，简单的栗子：  </p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[[[RACSignal createSignal:^RACDisposable *(<span class="keyword">id</span>&lt;RACSubscriber&gt; subscriber) &#123;</span><br><span class="line">    [subscriber sendNext:<span class="string">@"1"</span>];</span><br><span class="line">    [subscriber sendNext:<span class="string">@"2"</span>];</span><br><span class="line">    [subscriber sendNext:<span class="string">@"3"</span>];</span><br><span class="line">    [subscriber sendCompleted];</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nil</span>;</span><br><span class="line">&#125;] skip:<span class="number">1</span>] subscribeNext:^(<span class="keyword">id</span> x) &#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"only 2 and 3 will be print: %@"</span>, x);</span><br><span class="line">&#125;];</span><br></pre></td></tr></table></figure>
<h3 id="skipUntilBlock-BOOL-id-x"><a href="#skipUntilBlock-BOOL-id-x" class="headerlink" title="- skipUntilBlock:(BOOL (^)(id x))"></a>- skipUntilBlock:(BOOL (^)(id x))</h3><p>和<code>- takeUntilBlock:</code>同理，一直跳，直到block为YES</p>
<h3 id="skipWhileBlock-BOOL-id-x"><a href="#skipWhileBlock-BOOL-id-x" class="headerlink" title="- skipWhileBlock:(BOOL (^)(id x))"></a>- skipWhileBlock:(BOOL (^)(id x))</h3><p>和<code>- takeWhileBlock:</code>同理，一直跳，直到block为NO</p>
<hr>
<h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p>本章介绍了RAC中Filter类型的Operation，总结一下：</p>
<ul>
<li>适用场景：需要一个next值集合的<code>子集</code>时</li>
<li>Filter类型：值过滤型和起止点过滤型</li>
<li>值过滤型常用方法： <code>-filter:</code>，<code>-ignore:</code>，<code>-distinctUnitlChanged</code></li>
<li>起止点过滤型常用方法：<code>take</code>系列和<code>skip</code>系列</li>
</ul>
<h1 id="References"><a href="#References" class="headerlink" title="References"></a>References</h1><p><a href="https://github.com/ReactiveCocoa/ReactiveCocoa/blob/master/Documentation/BasicOperators.md#filtering" target="_blank" rel="external">https://github.com/ReactiveCocoa/ReactiveCocoa/blob/master/Documentation/BasicOperators.md#filtering</a></p>
<hr>
<p>原创文章，转载请注明源地址，<a href="blog.sunnyxx.com">blog.sunnyxx.com</a></p>
</div></article></div></section><footer><div class="paginator"><a href="/2014/04/22/objc_dig_nslog/" class="prev">上一篇</a><a href="/2014/04/13/objc_dig_interface/" class="next">下一篇</a></div><div data-thread-key="2014/04/19/rac_4_filters/" data-title="Reactive Cocoa Tutorial [4] = 只取所需的Filters" data-url="http://blog.sunnyxx.com/2014/04/19/rac_4_filters/" data-author-key="1" class="ds-thread"></div><script>var duoshuoQuery = {short_name:"sunnyxx"};
(function() {
    var ds = document.createElement('script');
    ds.type = 'text/javascript';ds.async = true;
    ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
    ds.charset = 'UTF-8';
    (document.getElementsByTagName('head')[0] 
     || document.getElementsByTagName('body')[0]).appendChild(ds);
})();

</script><div class="copyright"><p>原创文章，版权声明：署名-非商业性使用-相同方式共享 2.5 </p><p>对博主感兴趣？微信订阅号中关注 sunnyxx 或关注微博<a href="http://weibo.com/1364395395/">@我就叫Sunny怎么了</a></p><p>© 2015 - 2016  <a href="http://blog.sunnyxx.com">sunnyxx</a> | Powered by Hexo</p></div></footer></body></html>